<template id="wasabi-host">
  <div id="wasabi-content">
  </div>
</template>
<script>

  var hosts = hosts || {};
  let importDoc = document.currentScript.ownerDocument;
  let template = importDoc.querySelector("#wasabi-host");
  console.log(template);

  class WasabiHost extends HTMLElement {
    constructor() {
      super();
      this._root = this.attachShadow({ mode: 'open' });
      this._root.appendChild(template.content.cloneNode(true));
      this.ctx ="";
      this._inited = false;
    }

    init(className) {
      console.log(className);
      return new Promise(function (resolve, reject) {
        let ctx = self.ctx;
        if (!ctx) {
          console.log("pas ctx?", ctx)
           ctx = new AudioContext();
        }else{
          console.log("ctx", ctx)
          self.ctx = ctx;
        }
        var hostsClass = hosts[className];
        var plug = new hostsClass(ctx);
        resolve(plug);
      });
    }

    load(url, className) {
      var self = this;
      var plug;
      return new Promise(function (resolve, reject) {
        function loaded() {
          if (!className) {
            var tokens = url.split("/");
            className = tokens[tokens.length-1].split(".")[0];
            //className = className.toUpperCase();
          }          
          self.init(className).then((wasabi) => {
            var detail = { url: url, wasabi: wasabi, status: 200 }
            var event = new CustomEvent("load", { detail: detail });
            self.dispatchEvent(event);

            resolve(wasabi);
          });
          if (url.endsWith(".html")) {
          let wc = document.createElement(this.import.head.querySelector("template").id);
          let content = self.shadowRoot.getElementById("wasabi-content");
          content.appendChild(wc);
          }
        }
        

        if (url.endsWith(".js")) {
          var script = document.createElement('script');
          script.src = url;
          script.onload = loaded;
          document.head.appendChild(script);
        }
        else if (url.endsWith(".html")) {
          var link = document.createElement('link');
          link.rel = 'import';
          link.id = 'urlPlugin';
          link.href = url;
          link.onload = loaded;
          document.head.appendChild(link);
          console.log("2");
        }
        else reject("invalid argument");
      });
    }
  }




  window.customElements.define('wasabi-host', WasabiHost);


</script>