<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js"></script>
<script>
	WebAudioControlsOptions = {
		useMidi: 1,
	};
</script>
<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webaudio-controls.js"></script>
<template>
	<style>
		.pedal {
			display: block;
			background-color: #AB2E24;
			width: 120px;
			height: 180px;
			border-radius: 10px;
			position: relative;
			/* bring your own prefixes */
		}


		#background-image {
			//border: solid 2px black;
			width: 120px;
			height: 180px;
			opacity: 1;
		}

		#resize {
			position: absolute;
			cursor: nwse-resize;
			width: 10px;
			height: 10px;
			left: 112px;
			top: 172px;
			border: 1px solid black;
		}

		.knob,
		.switch,
		.icon,
		.label {
			position: absolute;
			cursor: pointer;
		}
		.webaudioctrl-tooltip {
			color: #000 !important;
			font-size: 11px !important;
		}

		.selected {
			border: 1px dashed black;
			cursor: move;
		}

		.selected:hover {
			border: 1px dashed black;
			cursor: move;
		}

		.selected webaudio-knob {
			cursor: move;
		}

		.selected webaudio-switch {
			cursor: move;
		}

		.selected span {
			cursor: move;
		}

		.selected:hover span {
			cursor: move;
		}

		.selected webaudio-slider {
			cursor: move;
		}

		.selected:hover webaudio-knob {
			cursor: move;
		}

		.selected:hover webaudio-switch {
			cursor: move;
		}

		.selected:hover webaudio-slider {
			cursor: move;
		}


		#switch1 {
			bottom: 10px;
			right: 0px;
		}

		#highgain {
			left: 66px;
			top: 70px;
		}

		#highgain div {
			color: #ffffff;
			font-family: "Verdana";
			font-size: 8px;

		}

		#midhighgain {
			left: 12px;
			top: 71px;
		}

		#midhighgain div {
			color: #ffffff;
			font-family: "Verdana";
			font-size: 8px;

		}

		#midlowgain {
			left: 65px;
			top: 12px;
		}

		#midlowgain div {
			color: #ffffff;
			font-family: "Verdana";
			font-size: 8px;

		}

		#lowgain {
			left: 12px;
			top: 12px;
		}

		#lowgain div {
			color: #ffffff;
			font-family: "Verdana";
			font-size: 8px;

		}

		#label_413 {
			left: 16px;
			top: 130px;
			color: #ffffff;
			font-family: "Arial Black";
			font-size: 14px;
		}



		.pedalLabel {
			position: absolute;
			top: 225px;
			font-size: 25px;
			font-family: Sansita;
			/*{font}*/
			text-align: center;
			line-height: 30px;
			/*{pedalfontsize}*/
			width: 150px;
			color: #6B0000;
			/*{fontcolor}*/
		}

		.knob-label {
			position: absolute;
			font-size: 12px;
			/*{knobfontsize}*/
			line-height: 12px;
			width: 64px;
			max-width: 64px;
			overflow: hidden;
			text-align: center;
			font-family: Sansita;
			/*{font}*/
			color: #6B0000;
			/*{fontcolor}*/
		}

		#knob1-label {
			top: 84px;
			left: 43px;
		}
	</style>
	<div class="pedal">
		<img id="background-image">
		<div class="switchCont" id="switch1">
			<webaudio-switch class="switch" id="switch1" height="15" width="30"></webaudio-switch>
		</div>
		<div class="knob" id="highgain">
			<webaudio-knob height="40" width="40" sprites="100" min="0" max="1" step="0.01" value="0.5" tooltip="High Frequency Gain %.2f"></webaudio-knob>
			<div style="text-align:center">Highgain</div>
		</div>
		<div class="knob" id="midhighgain">
			<webaudio-knob height="40" width="40" sprites="100" min="0" max="1" step="0.01" value="0.5" tooltip="Medium - High Frequency Gain %.2f"></webaudio-knob>
			<div style="text-align:center">Midhighgain</div>
		</div>
		<div class="knob" id="midlowgain">
			<webaudio-knob height="40" width="40" sprites="100" min="0" max="1" step="0.01" value="0.8"tooltip="Medium - Low Frequency Gain %.2f"></webaudio-knob>
			<div style="text-align:center">Midlowgain</div>
		</div>
		<div class="knob" id="lowgain">
			<webaudio-knob height="40" width="40" sprites="100" min="0" max="1" step="0.01" value="0.6" tooltip="Low Frequency Gain %.2f"></webaudio-knob>
			<div style="text-align:center">Lowgain</div>
		</div>
		<div class="label" id="label_413">QuadraFuzz</div>
	</div>
</template>
<script>
	let QuadraFuzzTemp = document.currentScript.ownerDocument.querySelector('template');
	class QuadraFuzzGui extends HTMLElement {


		constructor(plug) {

			super();
			this._plug = plug;
			this._plug.gui = this;
			console.log(this._plug);
			this._root = this.attachShadow({ mode: 'open' });
			this._root.appendChild(QuadraFuzzTemp.content.cloneNode(true));
			this.knobs = this._root.querySelectorAll(".knob");
			this.isOn;
			this.state = new Object();
			this.setKnobs();
			this.setSwitchListener();
			this.setResources();

		}

		get properties() {

			this.boundingRect = {
				dataWidth: {
					type: Number,
					value: 120
				},
				dataHeight: {
					type: Number,
					value: 180
				}
			};
			return this.boundingRect;

		}

		static get observedAttributes() {

			return ['state'];

		}

		attributeChangedCallback() {

			this.state = JSON.parse(this.getAttribute('state'));
			console.log(this.state);
			if (this.state.status == "enable") {
				this._root.querySelector("#switch1").querySelector("webaudio-switch").value = 1;
				this.isOn = true;
			}
			for (var i = 0; i < this.knobs.length; i++) {
				this.knobs[i].querySelector("webaudio-knob").value = this.state[this.knobs[i].id];
			}

		}

		setResources() {
			var background = this._root.querySelector("img");
			background.src = this._plug.URL + '/assets/background.png';
			background.style = 'border-radius : 5px;'
			this._root.querySelectorAll(".knob").forEach((knob) => {
				console.log(knob.querySelector("webaudio-knob").src);
				knob.querySelector("webaudio-knob").setAttribute('src', this._plug.URL + '/assets/MiniMoog_Main.png');
			});
			this._root.querySelector("#switch1").querySelector("webaudio-switch").setAttribute('src', this._plug.URL + '/assets/switch_1.png');
		}

		eventToKnob(rank) {
			this.knobs[rank].querySelector("webaudio-knob").addEventListener('input', (e) =>
				this._plug.setParam(this.knobs[rank].id, e.target.value));
		}

		setKnobs() {
			// must a function here to have real value of id.
			for (var i = 0; i < this.knobs.length; i++) {
				this.eventToKnob(i);
			}
		}

		bypass() {
			this._plug.setParam("status", "disable");
		}


		reactivate() {
			this._plug.setParam("status", "enable");
		}

		setSwitchListener() {
			this._root.querySelector("#switch1").querySelector("webaudio-switch").addEventListener('change', (e) => {
				if (this.isOn) this.bypass()
				else this.reactivate();
				this.isOn = !this.isOn;
			});
		}

	}

	try {
		customElements.define('wasabi-quadrafuzz', QuadraFuzzGui);
		console.log("Element defined");
	} catch (error) {
		console.log(error);
		console.log("Element already defined");
	}

	createQuadraFuzz = (plug) => {
		let elem = new QuadraFuzzGui(plug);
		return elem;
	}
</script>