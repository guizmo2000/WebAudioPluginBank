<script src="./PingPongDelay.js"></script>
<script>UseWebAudioControlsMidi = 1</script>
<dom-module id="wc-pingpongdelay">
  <template>
    <style>
      :host {
        box-shadow: inset -3px -3px 3px 5px rgba(0, 0, 0, 0.6), inset 3px 3px 3px 5px rgba(255, 255, 255, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.9), 0 4px 5px 0 rgba(0, 0, 0, 0.9), 0 1px 10px 0 rgba(0, 0, 0, 0.9);

        width: [[dataWidth]]px;
        height: [[dataHeight]]px;
        border-radius: 10px;

        position: absolute;
        top: 0px;
        left: 0px;
        display: block;
        user-select: none;
        cursor: move;
      }

      webaudio-switch {
        left: -6px;
      }

      .pedalLabel {
        font-size: 20px;
        text-align: center;
        user-select: none;
        font-family: Lemon\/Milk;
      }

      .knob-label {
        font-size: 10px;

        text-align: center;
        overflow: hidden;
        user-select: none;
      }

      .elements {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 10px;
      }

      .column {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;

        flex: 1;
        margin: 1px;
      }

      .row {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: stretch;
      }
      /***** .input,.output  *****/

      .input,
      .output {
        position: absolute;
        top: 20px;
      }

      .output:hover {
        background-image: url("../../../../img/outputHover.png");
      }

      .output {
        background-image: url("../../../../img/output.png");
        background-repeat: no-repeat;
        background-position: center center;

        width: 90px;
        height: 20px;

        right: -88px;
      }


      .input:hover {
        background-image: url("../../../../img/inputHover.png");
      }

      .input {
        background-image: url("../../../../img/input.png");
        background-repeat: no-repeat;
        background-position: left center;

        width: 20px;
        height: 20px;

        left: -20px;
      }
      /***** div_menuPanel *****/

      .div_menuPanel {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: stretch;

        position: absolute;
        top: -28px;
        right: 12px;
        z-index: 99;
      }

      .div_menuPanel button:hover>iron-icon {
        color: #fff;
      }

      .div_menuPanel button:hover {
        background: rgba(0, 0, 0, 0.4);
      }

      .div_menuPanel button {
        background: transparent;
        border: 0px;

        cursor: pointer;
      }

      .div_menuPanel button iron-icon {
        color: #bbb;
        width: 16px;
      }
    </style>
    <div class="row">
      <div class="column">
        <webaudio-knob id="knob1" class="knob" sprites="99" value="0" step="1" midilearn="true" src="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/img/nux_yellow_not_stripped.png"
          width="40" height="40" data-role="feedback"></webaudio-knob>
        <span class="knob-label" id="knob1-label">FEEDBACK</span>
      </div>
      <div class="column">
        <webaudio-knob id="knob2" class="knob" sprites="99" value="0" step="1" midilearn="true" src="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/img/nux_yellow_not_stripped.png"
          width="40" height="40" data-role="time"></webaudio-knob>
        <span class="knob-label" id="knob2-label">TIME</span>
      </div>
    </div>
    <div class="row">
      <div class="column">
        <webaudio-knob id="knob3" class="knob" sprites="99" value="0" step="1" midilearn="true" src="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/img/nux_yellow_not_stripped.png"
          width="40" height="40" data-role="mix"></webaudio-knob>
        <span class="knob-label" id="knob3-label">MIX</span>
      </div>
    </div>

    <div class="row">
      <div class="column">
        <webaudio-switch id="switch1" class="switch" midilearn="true" src="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/img/switch_1.png" width="40" height="25"></webaudio-switch>
      </div>
    </div>
    <div class="row">
      <div class="column">
        <span class="pedalLabel">DELAY</span>
      </div>
    </div>
  </template>
  <script>
    class WCPingPongDelay extends Polymer.Element {

      static get is() { return 'wc-pingpongdelay'; }

      constructor(){
        super();
        // buildGraph(ctx);
      }

      static get properties() {
        this.boundingRect = {
          dataWidth: {
            type: Number,
            value: 120
          },
          dataHeight: {
            type: Number,
            value: 180
          }
        };
        return this.boundingRect;
      }
      buildGraph(ctx){
        this.effect = new PingPongDelay(ctx);
        console.log(this.effect)
        this.$.knob1.addEventListener('change', (e) => this.effect.setParam("feedback",e.target.value / 100));
        this.$.knob2.addEventListener('change', (e) => this.effect.setParam("time",e.target.value / 100));
        this.$.knob3.addEventListener('change', (e) => this.effect.setParam("mix",e.target.value / 100));
        this.setSwitchListener();
        this.bypass();

      }

      // feedbackListener(event){
      //   this.effect.setFeedback(event.target.value/100);
      // }
      // timebackListener(event){
      //   this.effect.setTime(event.target.value/100);
      // }
      // mixListener(event){
      //   this.effect.setMix(event.target.value/100);
      // }


      setSwitchListener() {
        this.$.switch1.addEventListener('change',(e)=>{
          if (this.isOn) this.bypass();
          else this.reactivate();

          this.isOn = !this.isOn;
        });
      }
      setPedalActive(active) {
        if (active == undefined || active == false) {
          this.isOn = false;
          this.bypass();
          this.$.switch1.value = 0;
        } else if (active) {
          this.isOn = true;
          this.reactivate();
          this.$.switch1.value = 1;
        }
      }
      getEffect(){
        return this.effect;
      }
      bypass() {
        this.effect.setState("disable");
      }
      reactivate() {
        this.effect.setState("enable");
      }

    }
    // Register the x-custom element with the browser
    customElements.define(WCPingPongDelay.is, WCPingPongDelay);
    console.log(WCPingPongDelay.is);
  </script>
</dom-module>
