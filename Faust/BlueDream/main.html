<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js"></script>
<script>
  WebAudioControlsOptions = {
    useMidi: 1,
  };
</script>
<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webaudio-controls.js"></script>
<template>
  <style>
    .pedal {
      display: block;
      background-color: #498dab;
      width: 164px;
      height: 220px;
      border-radius: 10px;
      position: relative;
      /* bring your own prefixes */
      box-shadow: 4px 5px 6px rgba(0, 0, 0, 0.7),
        inset -2px -2px 5px 0px rgba(0, 0, 0, 0.2),
        inset 3px 1px 1px 4px rgba(255, 255, 255, 0.2),
        1px 0px 1px 0px rgba(0, 0, 0, 0.9),
        0 2px 1px 0 rgba(0, 0, 0, 0.9),
        1px 1px 1px 0px rgba(0, 0, 0, 0.9);
    }


    #background-image {
      //border: solid 2px black;
      width: 164px;
      height: 220px;
      opacity: 1;
    }

    #resize {
      position: absolute;
      cursor: nwse-resize;
      width: 10px;
      height: 10px;
      left: 136px;
      top: 212px;
      border: 1px solid black;
    }

    .knob,
    .switch,
    .icon,
    .label,
    .slider {
      position: absolute;
      cursor: pointer;
      text-align: center;
    }



    .selected {
      border: 1px dashed black;
      cursor: move;
    }

    .selected:hover {
      border: 1px dashed black;
      cursor: move;
    }

    .selected webaudio-knob {
      cursor: move;
    }

    .selected webaudio-switch {
      cursor: move;
    }

    .selected span {
      cursor: move;
    }

    .selected:hover span {
      cursor: move;
    }

    .selected webaudio-slider {
      cursor: move;
    }

    .selected:hover webaudio-knob {
      cursor: move;
    }

    .selected:hover webaudio-switch {
      cursor: move;
    }

    .selected:hover webaudio-slider {
      cursor: move;
    }


    #switch1 {
      bottom: 10px;
      right: 10px;
    }

    #volume {
      left: 10px;
      top: 10px;
    }

    #volume div {
      color: #ffffff;
      font-family: "Verdana";
      font-size: 10px;

    }

    #voice {
      left: 60px;
      top: 10px;
    }

    #voice div {
      color: #ffffff;
      font-family: "Verdana";
      font-size: 10px;

    }

    #treble {
      left: 110px;
      top: 10px;
    }

    #treble div {
      color: #ffffff;
      font-family: "Verdana";
      font-size: 10px;

    }

    #middle {
      left: 10px;
      top: 70px;
    }

    #middle div {
      color: #ffffff;
      font-family: "Verdana";
      font-size: 10px;

    }

    #drive {
      left: 60px;
      top: 70px;
    }

    #drive div {
      color: #ffffff;
      font-family: "Verdana";
      font-size: 10px;

    }

    #bass {
      left: 110px;
      top: 70px;
    }

    #bass div {
      color: #ffffff;
      font-family: "Verdana";
      font-size: 10px;

    }

    #switch_178 {
      left: 53px;
      top: 166px;
    }

    #switch_178 div {
      color: #ffffff;
      font-family: "Comic Sans MS";
      font-size: 12px;

    }

    #label_243 {
      left: 34px;
      top: 142px;
      color: #ffffff;
      font-family: "Arial Black";
      font-size: 14px;
    }



    .pedalLabel {
      position: absolute;
      top: 225px;
      font-size: 25px;
      font-family: Sansita;
      /*{font}*/
      text-align: center;
      line-height: 30px;
      /*{pedalfontsize}*/
      width: 150px;
      color: #6B0000;
      /*{fontcolor}*/
    }

    .knob-label {
      position: absolute;
      font-size: 12px;
      /*{knobfontsize}*/
      line-height: 12px;
      width: 64px;
      max-width: 64px;
      overflow: hidden;
      text-align: center;
      font-family: Sansita;
      /*{font}*/
      color: #6B0000;
      /*{fontcolor}*/
    }

    #knob1-label {
      top: 84px;
      left: 73px;
    }
  </style>
  <div class="pedal">

    <!-- <p class="knob-label" id="knob1-label" contenteditable="true">FREQ</p> -->
    <!-- <img id="background-image"> -->

    <div class="knob " id="volume">
      <webaudio-knob height="40" width="40" sprites="100" min="0" max="1" step="0.01" value="0.5" style="height: 40px;"
        id="/kpp_bluedream/volume"></webaudio-knob>
      <div style="text-align:center">volume</div>
    </div>
    <div class="knob " id="voice">
      <webaudio-knob height="40" width="40" sprites="100" min="0" max="1" step="0.01" value="0.5" style="height: 40px;"
        id="/kpp_bluedream/voice"></webaudio-knob>
      <div style="text-align:center">voice</div>
    </div>
    <div class="knob " id="treble">
      <webaudio-knob height="40" width="40" sprites="100" min="-15" max="15" step="1" value="0.6" style="height: 40px;"
        id="/kpp_bluedream/treble"></webaudio-knob>
      <div style="text-align:center">treble</div>
    </div>
    <div class="knob " id="middle">
      <webaudio-knob height="40" width="40" sprites="100" min="-15" max="15" step="1" value="-3.9" style="height: 40px;"
        id="/kpp_bluedream/middle"></webaudio-knob>
      <div style="text-align:center">middle</div>
    </div>
    <div class="knob " id="drive">
      <webaudio-knob height="40" width="40" sprites="100" min="0" max="100" step="1" value="63" style="height: 40px;"
        id="/kpp_bluedream/drive"></webaudio-knob>
      <div style="text-align:center">drive</div>
    </div>
    <div class="knob " id="bass">
      <webaudio-knob height="40" width="40" sprites="100" min="-15" max="15" step="1" value="-6.9" style="height: 40px;"
        id="/kpp_bluedream/bass"></webaudio-knob>
      <div style="text-align:center">bass</div>
    </div>
    <div class="label    " id="label_243">Blue Dream</div>
    <div class="switch" id="switch_178">
      <webaudio-switch id="switch1" height="25" width="50"></webaudio-switch>
    </div>
  </div>
</template>
<script>
  let BlueDreamTemp = document.currentScript.ownerDocument.querySelector('template');
  class BlueDreamGui extends HTMLElement {


    constructor(plug) {

      super();
      this._plug = plug;
      this._plug.gui = this;
      console.log(this._plug);
      this._root = this.attachShadow({ mode: 'open' });
      this._root.appendChild(BlueDreamTemp.content.cloneNode(true));
      this.isOn;
      this.knobs = this._root.querySelectorAll(".knob");
      this.state = new Object();
      this.setKnobs();
      this.setSwitchListener();
      this.setResources();

    }

    attributeChangedCallback() {

      this.state = JSON.parse(this.getAttribute('state'));
      let tmp = "/kpp_bluedream/bypass";
      console.log(this._root.querySelector("#switch_178").querySelector("#switch1").value);
      if (this.state[tmp] == 1) {
        this._root.querySelector("#switch_178").querySelector("#switch1").value = 0;
        this.isOn = false;
      } else if (this.state[tmp] == 0) {

        this._root.querySelector("#switch_178").querySelector("#switch1").value = 1;
        this.isOn = true;
      }
      this.knobs = this._root.querySelectorAll(".knob");
      try {
        for (var i = 0; i < this.knobs.length; i++) {
          this.knobs[i].querySelector("webaudio-knob").setValue(this.state[this.knobs[i].querySelector("webaudio-knob").id], false);
        }
      } catch (error) {
        console.warn("GUI not initiated");
      }
    }

    get properties() {

      this.boundingRect = {
        dataWidth: {
          type: Number,
          value: 164
        },
        dataHeight: {
          type: Number,
          value: 220
        }
      };
      return this.boundingRect;

    }

    static get observedAttributes() {

      return ['state'];

    }

    setResources() {

      // Sets the background image and style.
      // var background = this._root.querySelector('img');
      // background.src = this._plug.URL + '/assets/undefined';
      // background.style = 'border-radius : 10px;'

      this._root.querySelectorAll(".knob").forEach((knob) => {
        knob.querySelector("webaudio-knob").setAttribute('src', this._plug.URL + '/assets/MiniMoog_Main.png');
      });

      this._root.querySelectorAll(".switch").forEach((s) => {
        this._root.querySelector("webaudio-switch").setAttribute('src', this._plug.URL + '/assets/switch_1.png');
      });



    }

    setKnobs() {
      this._root.querySelector("#drive").querySelector("webaudio-knob").addEventListener("input", (e) => this._plug.setParam("/kpp_bluedream/drive", e.target.value));
      this._root.querySelector("#volume").querySelector("webaudio-knob").addEventListener("input", (e) => this._plug.setParam("/kpp_bluedream/volume", e.target.value));
      this._root.querySelector("#treble").querySelector("webaudio-knob").addEventListener("input", (e) => this._plug.setParam("/kpp_bluedream/treble", e.target.value));
      this._root.querySelector("#bass").querySelector("webaudio-knob").addEventListener("input", (e) => this._plug.setParam("/kpp_bluedream/bass", e.target.value));
      this._root.querySelector("#middle").querySelector("webaudio-knob").addEventListener("input", (e) => this._plug.setParam("/kpp_bluedream/middle", e.target.value));
      this._root.querySelector("#voice").querySelector("webaudio-knob").addEventListener("input", (e) => this._plug.setParam("/kpp_bluedream/voice", e.target.value));

    }



    setSwitchListener() {

      console.log("setswitch");
      this._root.querySelector(".switch").querySelector("webaudio-switch").addEventListener('change', (e) => {
        if (this.isOn) this.bypass()
        else this.reactivate();
        this.isOn = !this.isOn;
      });

    }
    bypass() {
      this._plug.setParam("/kpp_bluedream/bypass", 1);
    }

    reactivate() {
      this._plug.setParam("/kpp_bluedream/bypass", 0);
    }
  }
  try {
    customElements.define('faust-bluedream', BlueDreamGui);
    console.log("Element defined");
  } catch (error) {
    console.log(error);
    console.log("Element already defined");
  }

  createBlueDreamGUI = (plug) => {
    let elem = new BlueDreamGui(plug);
    return elem;
  }
</script>