<!-- <script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js"></script> -->
<script>
  WebAudioControlsOptions = {
    useMidi: 1,
  };
</script>
<script src='./../scripts/querty-hancock.js'></script>
<script src="./../../bower_components/webaudio-controls2/webaudio-controls.js"></script>
<link rel="import" href="https://wasabi.i3s.unice.fr/WebAudioPluginBank/Mike-AUBENAS/Visualizers/FrequencyViewer/frequencyViewer.html">
<template id="wc-minilogue">
  <style>
    :host {
      background: linear-gradient( rgb(77, 74, 78), rgb(221, 221, 221));
      box-shadow: 4px 5px 6px rgba(0, 0, 0, 0.7), inset -2px -2px 5px 0px rgba(0, 0, 0, 0.2), inset 3px 1px 1px 4px rgba(255, 255, 255, 0.2), 1px 0px 1px 0px rgba(0, 0, 0, 0.9), 0 2px 1px 0 rgba(0, 0, 0, 0.9), 1px 1px 1px 0px rgba(0, 0, 0, 0.9);


      width: 640px;
      height: 250px;
      display: block;
      user-select: none;
      cursor: move;
      z-index: 9;

      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    #minimalGUI {
      background: rgba(97, 57, 5, 0.63);
      padding: 5px;
      margin: 0px;
    }

    #show {
      background: rgb(221, 221, 221);
      border-radius: 30%;
      padding: 0.1%;
      margin-right: 2%
    }

    *:focus {
      outline: 0;
    }

    .pedalLabel,
    .div_buttons {
      border-radius: 8px;
    }

    .div_menuPanel {
      /* border-top-left-radius: 8px;
        border-top-right-radius: 8px; */
    }

    webaudio-switch {
      left: -6px;
    }

    .pedalLabel {
      /* background: rgba(0, 0, 0, 0.4); */
      box-shadow: inset 0px 1px 5px #111;
      border: 1px solid #ccc;
      color: #ccc;
      /* border:2px solid #aaa; */
      padding: 4px 10px;
      margin-left: 2%;

      font-size: 8px;
      text-align: center;
      user-select: none;
      /* font-family: Lemon\/Milk; */
      font-family: helvetica;
      text-transform: uppercase;
    }

    .knob-label {
      color: #ddd;
      text-shadow: 0px 1px 1px #000;

      font-size: 6px;
      margin-top: -2px;

      text-align: center;
      text-transform: uppercase;
      overflow: hidden;
      user-select: none;
      font-family: helvetica;

    }

    .elements {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;

      padding: 10px;
    }

    .column {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;

      flex: 1;
      margin: 3px;
    }

    .row {
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: stretch;
    }

    #freqview{
      border:solid;
      border-width: 1px;
      border-color: azure;
    }
  </style>
  <div class="column" id="minimalGUI">
    <div class="row">
      <button id="show">GUI</button>
      <select id="midiport">
        <option>--</option>
      </select>
      <span class="pedalLabel" id="name">Minilogue</span>
    </div>

  </div>
  <div id="GUI">
    <div class="row">
      <div class="column">
        <span class="pedalLabel">Master</span>
        <div class="row">
          <div class="column">
            <webaudio-knob id="master" class="knob" sprites="99" min="0" max="10" value="5" step="0.01" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="master-label">Master</span>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <webaudio-knob id="noise" class="knob" sprites="99" min="0" max="3" value="0.1" step="0.1" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="noise-label">Noise</span>
          </div>
        </div>
      </div>
      <div class="column">
        <span class="pedalLabel">OSC</span>
        <div class="row">
          <div class="column">
            <webaudio-slider class="knob" id="osc1octave" midilearn="1"  value="3" min="1" max="5" step="1" width="15" height="24"
              tooltip="Slider-L"></webaudio-slider>
            <span class="knob-label" id="osc1pitch-label">Osc1 octave</span>
          </div>
          <div class="column">
            <webaudio-slider class="knob" id="wave1" midilearn="1" value="0" min="0" max="2" step="1" width="15" height="24" tooltip="Slider-L"></webaudio-slider>
            <span class="knob-label" id="osc1pitch-label">Osc1 wave</span>
          </div>
          <div class="column">
            <webaudio-knob id="osc1pitch" class="knob" min=0.5 max="2" sprites="99" value="1" step="0.01" midilearn="true" data-role="feedback"
              diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc1pitch-label">Osc1 pitch</span>
          </div>
          <div class="column">
            <webaudio-knob id="osc1shape" class="knob" min="0" max="100" sprites="99" value="0.5" step="0.01" midilearn="true" data-role="feedback"
              diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc1shape-label">Osc1 shape</span>
          </div>
          <div class="column">
            <webaudio-knob id="osc1gain" class="knob" sprites="99" min="0" max="3" value="3" step="0.01" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc1gain-label">Osc1 Gain</span>
          </div>
          <!-- <div class="column">
              <webaudio-slider class="selector" id="ringmodulation" midilearn="1" value="0" min="0" max="1" step="1" width="15" height="24"
                tooltip="Slider-L"></webaudio-slider>
              <span class="knob-label" id="osc1pitch-label">Ring</span>
            </div> -->
        </div>
        <div class="row">
          <div class="column">
            <webaudio-slider class="knob" id="osc2octave" midilearn="1" midicc="2.0" value="3" min="1" max="5" step="1" width="15" height="24"
              tooltip="Slider-L"></webaudio-slider>
            <span class="knob-label" id="osc1pitch-label">Osc2 octave</span>
          </div>
          <div class="column">
            <webaudio-slider class="knob" id="wave2" midilearn="1" midicc="1.23" value="0" min="0" max="2" step="1" width="15" height="24"
              tooltip="Slider-L"></webaudio-slider>
            <span class="knob-label" id="osc1pitch-label">Osc2 wave</span>
          </div>
          <div class="column">
            <webaudio-knob id="osc2pitch" class="knob" min="0.5" max="2" sprites="99" value="1" step="0.01" midilearn="true" sr diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc2pitch-label">Osc2 pitch</span>
          </div>
          <div class="column">
            <webaudio-knob id="osc2shape" class="knob" min="0" max="100" sprites="99" value="0.5" step="0.01" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc2shape-label">Osc2 Shape</span>
          </div>
          <div class="column">
            <webaudio-knob id="osc2gain" class="knob" sprites="99" min="0" max="3" step="0.01" value="3" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc2gain-label">Osc2 Gain</span>
          </div>
        </div>
      </div>
      <div class="column">
        <span class="pedalLabel">Filter</span>
        <div class="row">
          <div class="column">
            <webaudio-knob id="lowpass" class="knob" min="30" max="5000" sprites="99" value="2000" step="1" midilearn="true" diameter="30"
              midicc="1.7"></webaudio-knob>
            <span class="knob-label" id="lowpass-label">cutoff</span>
          </div>
          <div class="column">
            <webaudio-knob id="highpass" class="knob" min="30" max="5000" sprites="99" value="30" step="0.01" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="highpass-label">High pass</span>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <webaudio-knob id="resonance" class="knob" sprites="99" min="0" max="30" value="0.1" step="0.01" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="resonance-label">Resonance</span>
          </div>
        </div>
      </div>
      <div class="column">
        <span class="pedalLabel">EG</span>
        <div class="row">
          <div class="column">
            <webaudio-knob id="ampattack" class="knob" min="0.001" max="5" sprites="99" value="0.001" step="0.1" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc1pitch-label">Attack</span>
          </div>
          <div class="column">
            <webaudio-knob id="ampdecay" class="knob" min="0.001" max="5" sprites="99" value="1" step="0.1" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc1shape-label">Decay</span>
          </div>
          <div class="column">
            <webaudio-knob id="ampsustain" class="knob" min="0.001" max="1" sprites="99" value="0.5" step="0.01" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc1gain-label">Sustain</span>
          </div>
          <div class="column">
            <webaudio-knob id="amprelease" class="knob" min="0.001" max="5" sprites="99" value="0.001" step="0.1" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc1gain-label">Release</span>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <webaudio-knob id="egattack" class="knob" min="0.001" max="5" sprites="99" value="0.5" step="0.1" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc2pitch-label">Attack</span>
          </div>
          <div class="column">
            <webaudio-knob id="egdecay" class="knob" min="0.001" max="5" sprites="99" value="1" step="0.1" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc2shape-label">Decay</span>
          </div>
          <div class="column">
            <webaudio-knob id="egsustain" class="knob" min="0.001" max="1" sprites="99" value="0.5" step="0.01" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc2gain-label">Sustain</span>
          </div>
          <div class="column">
            <webaudio-knob id="egrelease" class="knob" smin="0.001" max="5" sprites="99" value="1" step="0.1" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="osc1gain-label">Release</span>
          </div>
        </div>
      </div>
      <div class="column">
        <span class="pedalLabel">LFO</span>
        <div class="row">
          <div class="column">
            <webaudio-knob id="lforate" class="knob" min="0" max="20" sprites="99" value="0" step="0.01" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="lforate-label">lfo rate</span>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <webaudio-slider class="knob" id="lfodest" midilearn="1" midicc="1.23" value="0" min="0" max="2" step="1" width="15" height="20"
              tooltip="Slider-L"></webaudio-slider>
            <span class="knob-label" id="osc1pitch-label">lfo dest</span>
          </div>
          <div class="column">
            <webaudio-knob id="lfoint" class="knob" min="1" max="1000" sprites="99" value="20" step="1" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="lfoint-label">lfo int</span>
          </div>
        </div>
      </div>

      <div class="column">
        <span class="pedalLabel">Delay</span>
        <div class="row">
          <div class="column">
            <webaudio-knob id="time" class="knob" min="0" max="1" sprites="99" value="0.5" step="0.01" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="time-label">delay time</span>
          </div>
          <div class="column">
            <webaudio-knob id="feedback" class="knob" min="0" max="1" sprites="99" value="0.5" step="0.01" midilearn="true" diameter="20"></webaudio-knob>
            <span class="knob-label" id="feedback-label">delay feedback</span>
          </div>
          <div class="column">
            <webaudio-switch id="switchDelay" midilearn="true" src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/img/switch_2.png"
              width="60" height="30"></webaudio-switch>
            <span class="knob-label" id="switchDelay-label">Delay</span>
          </div>
        </div>
        <div class="row">
          <div class="column" id="freqview">
          </div>

        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="column">
      <!-- <webaudio-keyboard id="keyboard" class="keyboard" height="90" keys="37" ></webaudio-knob> -->
      <div id="keyboard"></div>
    </div>
  </div>
</template>
<script>
  let minitemp = document.currentScript.ownerDocument.querySelector("#wc-minilogue");
  class MinilogueGui extends HTMLElement {

    constructor(plug) {
      super();
      console.log(plug);
      this._plug = plug;
      console.log(this._plug);
      this._root = this.attachShadow({ mode: 'open' });
      this._root.appendChild(minitemp.content.cloneNode(true));
      this.knobs = this._root.querySelectorAll(".knob");
      //this.sliders = this._root.querySelectorAll(".slider")
      this.isDelayOn = false;
      this.bypassDelay();
      this.setKnobs();
      this.setKeyboard();
      this.setSwitchListener();
      this.setViewer();
      this.setGuiListener();
      this.curMidi = 0;
      this.midiPort = [];
      this.currentPort = -1;
      this._root.querySelector('#midiport').onchange = (evt) => this.SelectMidi(evt.target.selectedIndex - 1);
      this.InitMidi();
      this.kb = this._root.querySelector("#keyboard");



    }

    get properties() {
      this.boundingRect = {
        dataWidth: {
          type: Number,
          value: 600
        },
        dataHeight: {
          type: Number,
          value: 260
        }
      };
      return this.boundingRect;
    }
    static get observedAttributes() { return ['state']; }

    attributeChangedCallback() {
      console.log(`Custom element ${this.is} attributes changed.`);
      this.state = JSON.parse(this.getAttribute('state'));
      console.log(this.state);
      if (this.state.status == "enable") {
        this._root.querySelector("#switch1").value = 1;
        this.isDelayOn = true;
      }
      this.labels = this._root.querySelectorAll(".knob-label");

      for (var i = 0; i < this.knobs.length; i++) {
        this.knobs[i].value = this.state[this.labels[i].innerHTML.toLowerCase().replace(/ /g, "")];
      }
      console.log(this.knobs);

    }
    setGuiListener() {
      this.shower = this._root.querySelector('#show');
      console.log(this._root.querySelector("#GUI").classList)
      this.shower.addEventListener('click', (e) => {
        if (this._root.querySelector("#GUI").style.display == 'block') {
          this._root.querySelector("#GUI").style.display = 'none';
          this.style.height = '130px';

        }
        else /*if (this._root.querySelector("#GUI").style.display == 'none')*/ {
          this._root.querySelector("#GUI").style.display = 'block';
          this.style.height = '250px';
        }
      });
      console.log("yes");

    }

    eventToKnob(rank) {
      this.knobs[rank].addEventListener('input', (e) =>
        this._plug.setParam(this.knobs[rank].id, e.target.value));
    }

    setKnobs() {
      // must a function here to have real value of id.
      for (var i = 0; i < this.knobs.length; i++) {
        this.eventToKnob(i);
      }
      // ring need an onchange and not on-input
      // this._root.querySelector("#ringmodulation").addEventListener('change',(e) =>this._plug.setParam('ringmodulation',e.target.value));
    }

    setViewer() {
      this.freqviewWrap = this._root.querySelector("#freqview");
      this.view = new FrequencyViewer(this._plug.context, this._plug.analyser);
      this.freqviewWrap.appendChild(this.view)

    }


    setKeyboard() {

      var settings = {
        id: 'keyboard',
        width: 500,
        height: 90,
        startNote: 'C1',
        whiteNotesColour: '#fff',
        blackNotesColour: '#000',
        borderColour: '#000',
        activeColour: '#00ffed',
        octaves: 3
      };
      var tmp = this._root.querySelector("#keyboard")
      this.keyboard = new QwertyHancock(settings, this._root);

      this.keyboard.keyDown =  (note, frequency) => {
        //console.log(frequency);
        this._plug.noteOn(frequency + 32);
      };

      this.keyboard.keyUp = (note, frequency) => {
        this._plug.noteOff(frequency + 32);

      };


    }

    setSwitchListener() {
      console.log("setswitch");
      this._root.querySelector("#switchDelay").addEventListener('change', (e) => {
        if (this.isDelayOn) this.bypassDelay()
        else this.reactivateDelay();
        this.isDelayOn = !this.isDelayOn;
      });
    }



    bypassDelay() {
      this._plug.setParam("delay", "disable");
    }
    reactivateDelay() {
      this._plug.setParam("delay", "enable");
    }

    SelectMidi(n) {
      this._root.querySelector('#midiport').selectedIndex = n + 1;
      this.currentPort = n;
    }

    InitMidi() {
      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(
          (access) => {
            console.log("====> MIDI ready.");
            setTimeout(() => {
              var it = access.inputs.values();
              for (var i = it.next(); !i.done; i = it.next()) {
                var e = document.createElement("option");
                e.innerHTML = i.value.name;
                this._root.querySelector('#midiport').appendChild(e);
                this.midiPort.push(i.value);
              }
              if (this.midiPort.length > 0) this.SelectMidi(this.midiPort.length - 1);
            }, 10);
          }, () => {
            console.log("MIDI is not available.");
          }
        );
      }
      webAudioControlsMidiManager.addMidiListener(event => {
        var data = event.data;
        var channel = data[0];
        var controlNumber = data[1];
        var value = data[2];
        if (channel != 248 && channel != 254) {
          console.log("Midi event hook: data:[" + data + "] channel:" + data[0] + " cc:" + controlNumber + " value:" + value);
        }
        switch (channel & 0xf0) {
          case 0x90:
            this._plug.noteOn(controlNumber);
            return;
          case 0x80:
            this._plug.noteOff(controlNumber);

            return;
        }
      });

    };

  }
  // Register the x-custom element with the browser

  try {
    console.log("Element defined");
    customElements.define('wasabi-minilogue', MinilogueGui);
  } catch (error) {
    console.log(error);
    console.log("Element already defined");
  }


  createMinilogue = (plug) => {
    let elem = new MinilogueGui(plug);
    return elem;
  }
</script>