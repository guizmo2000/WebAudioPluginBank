<script
    src="./../../../bower_components/webaudio-controls2/webcomponents-lite.js"></script>
<script>
    WebAudioControlsOptions = {
        useMidi: 1,
    };
</script>
<script
    src="./../../../bower_components/webaudio-controls2/webaudio-controls.js"></script>
<template id="wc-comp">
    <style>
        :host {
            background: linear-gradient(rgb(206, 183, 54), rgb(158, 124, 30));
            box-shadow: 4px 5px 6px rgba(0, 0, 0, 0.7), inset -2px -2px 5px 0px rgba(0, 0, 0, 0.2), inset 3px 1px 1px 4px rgba(255, 255, 255, 0.2), 1px 0px 1px 0px rgba(0, 0, 0, 0.9), 0 2px 1px 0 rgba(0, 0, 0, 0.9), 1px 1px 1px 0px rgba(0, 0, 0, 0.9);


            width: 180px;
            height: 220px;
            display: block;
            user-select: none;
            cursor: move;
            z-index: 9;
        }

        .pedalLabel,
        .div_buttons {
            border-radius: 8px;
        }

        .div_menuPanel {
            /* border-top-left-radius: 8px;
        border-top-right-radius: 8px; */
        }

        webaudio-switch {
            left: -6px;

        }

        span {
            font-family: helvetica;
            text-shadow: 0px 1px 1px #000;
        }

        .pedalLabel {
            /* background: rgba(0, 0, 0, 0.4); */
            box-shadow: inset 0px 1px 5px #111;
            border: 1px solid #ccc;
            color: rgb(204, 204, 204);
            padding: 4px 10px;

            font-size: 10px;
            text-align: center;
            user-select: none;
            font-family: helvetica;
            text-transform: uppercase;
            margin-top: 20px;
        }

        .knob-label {
            color: rgb(255, 255, 255);
            text-shadow: 0px 1px 1px #000;
            font-size: 9px;
            text-align: center;
            text-transform: uppercase;
            overflow: hidden;
            user-select: none;
            font-family: helvetica;
            margin-bottom: 18px;

        }

        .elements {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: center;

            padding: 10px;

        }

        .column {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            flex: 1;
            margin: 5px;
            margin-top: 10px;
            border-radius: 10px;
        }

        .column2 {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            flex: 1;
            margin: 5px;
            margin-top: 10px;
            text-align: center;
        }

        .column3 {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            flex: 1;
            margin: 5px;
            margin-top: 10px;
            text-align: center;
        }


        .row {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: stretch;

        }

        .label {
            text-align: center;
            margin-bottom: 10px;
        }
    </style>

    <div class="row">
        <div class="column">
            <div class="knob" id="threshold">
                <webaudio-knob id="/COMPRESSOR/0x00/Compression_Control/Threshold"  sprites="99" min="-100"
                    max="10" step="0.1" value="-30" midilearn="true"
                    src="./assets/nux_black_white_stripe.png"  width="40"
                    height="40" data-role="Threshold" diameter="24" tooltip="Threshold"></webaudio-knob>
            </div>

            <span class="knob-label" id="knob1-label" style="color: black">THRESHOLD</span>

            <div class="knob" id="ratio">
                <webaudio-knob id="/COMPRESSOR/0x00/Compression_Control/Ratio"  sprites="99" min="1"
                    max="20" step="0.1" value="5" midilearn="true"
                    src="./assets/nux_black_white_stripe.png"  width="40"
                    height="40" data-role="Threshold" diameter="24" tooltip="Ratio"></webaudio-knob>
            </div>

            <span class="knob-label" id="knob1-label" style="color: black">RATIO</span>

        </div>

        <div class="column2">
            <div class="knob" id="attack">
                <webaudio-knob
                    id="/COMPRESSOR/0x00/Compression_Response/Attack_____tooltip:_Time_constant_in_ms_(1/e_smoothing_time)_for_the_compression_gain__to_approach_(exponentially)_a_new_lower_target_level_(the_compression__`kicking_in')]"
                     sprites="99" min="1" max="1000" step="0.1" value="50" midilearn="true"
                    src="./assets/nux_black_white_stripe.png" width="40"
                    height="40" data-role="Threshold" diameter="24" tooltip="Attack"></webaudio-knob>
            </div>

            <span class="knob-label" id="knob1-label" style="color: black">ATTACK</span>

            <div class="knob" id="release">
                <webaudio-knob id="/COMPRESSOR/0x00/Compression_Response/Release"  sprites="99" min="1"
                    max="1000" step="0.1" value="500" midilearn="true"
                    src="./assets/nux_black_white_stripe.png" width="40"
                    height="40" data-role="Threshold" diameter="24" tooltip="Release"></webaudio-knob>
            </div>

            <span class="knob-label" id="knob1-label" style="color: black">RELEASE</span>

        </div>

        <div class="column3">
            <div class="knob" id="gain">
                <webaudio-knob id="/COMPRESSOR/Makeup_Gain"  sprites="99" min="5" max="15" step="1"
                    value="10" midilearn="true"
                    src="./assets/nux_black_white_stripe.png" width="40"
                    height="40" data-role="Threshold" diameter="24" tooltip="Gain"></webaudio-knob>
            </div>

            <span class="knob-label" id="knob1-label" style="color: black">GAIN</span>
        </div>
    </div>
    <div class="label">
        <div class="switch" id="bypass">
            <webaudio-switch id="/COMPRESSOR/0x00/Bypass" class="switch" midilearn="true"
                src="./assets/switch_1.png" width="32" height="20">
            </webaudio-switch>
        </div>
    </div>
    <div class="label">
        <span class="pedalLabel">Compressor</span>
    </div>
</template>

<script>
    let comptemp = document.currentScript.ownerDocument.querySelector("#wc-comp");
    class CompressorGUI extends HTMLElement {

        constructor(plug) {
            super();
            this._plug = plug;
            this._plug.gui = this;
            this._root = this.attachShadow({ mode: 'open' });
            this._root.appendChild(comptemp.content.cloneNode(true));
            this.knobs = this._root.querySelectorAll(".knob");
            this.isOn;
            this.state = new Object();
            this.setKnobs();
            this.setBypass();
            this._plug.setParam("/COMPRESSOR/Makeup_Gain", 10)
            this._plug.setParam("/COMPRESSOR/0x00/Bypass", 1);
        }

        get properties() {
            this.boundingRect = {
                dataWidth: {
                    type: Number,
                    value: 180
                },
                dataHeight: {
                    type: Number,
                    value: 220
                }
            };
            return this.boundingRect;
        }

        static get observedAttributes() { return ['state']; }

        attributeChangedCallback() {
            this.state = JSON.parse(this.getAttribute('state'));
            console.log(this.state);
            for (var i = 0; i < this.knobs.length; i++) {
                //this.knobs[i].querySelector("webaudio-konb").value = this.state[this.labels[i].innerHTML.toLowerCase().replace(/ /g, "")] * 100;
                this.knobs[i].querySelector("webaudio-knob").value = this.state[this.knobs[i].querySelector("webaudio-knob").id];
            }
            //this._root.querySelector("#threshold").querySelector("webaudio-knob").setValue(this._plug.getCOMPRESSOR0x00Compression_ControlThreshold.value, false);
        }

        setKnobs() {
            console.log('setknobs');
            this._root.querySelector("#threshold").querySelector("webaudio-knob").addEventListener('input', (e) => this._plug.setParam("/COMPRESSOR/0x00/Compression_Control/Threshold", e.target.value));
            this._root.querySelector("#ratio").querySelector("webaudio-knob").addEventListener('input', (e) => this._plug.setParam("/COMPRESSOR/0x00/Compression_Control/Ratio", e.target.value));
            this._root.querySelector("#attack").querySelector("webaudio-knob").addEventListener('input', (e) => this._plug.setParam("/COMPRESSOR/0x00/Compression_Response/Attack_____tooltip:_Time_constant_in_ms_(1/e_smoothing_time)_for_the_compression_gain__to_approach_(exponentially)_a_new_lower_target_level_(the_compression__`kicking_in')]", e.target.value));
            this._root.querySelector("#release").querySelector("webaudio-knob").addEventListener('input', (e) => this._plug.setParam("/COMPRESSOR/0x00/Compression_Response/Release", e.target.value));

            this._root.querySelector("#gain").querySelector("webaudio-knob").addEventListener('input', (e) => this._plug.setParam("/COMPRESSOR/Makeup_Gain", e.target.value));
        }

        setBypass() {
            this._root.querySelector("#bypass").querySelector("webaudio-switch").addEventListener('click', (e) => this._plug.setParam("/COMPRESSOR/0x00/Bypass", e.target.value - 1));
        }

    }

    // Register the x-custom element with the browser
    try {
        console.log("Element defined");
        customElements.define('wasabi-compressor', CompressorGUI);
    } catch (error) {
        console.log(error);
        console.log("Element already defined");
    }

    createuntitledGUI = (plug) => {
        let elem = new CompressorGUI(plug);
        return elem;
    }
</script>