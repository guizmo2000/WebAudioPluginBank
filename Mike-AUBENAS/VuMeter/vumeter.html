<template id="wc-vumeter">

    <style>

        canvas
        {
            background-color: rgba(255, 255, 255, 0);
        }

    </style>

    <canvas></canvas>

</template>

<script>

	/* 	See :

	 *	https://codepen.io/travisholliday/pen/gyaJk
	 *	https://developer.mozilla.org/fr/docs/Web/API/AnalyserNode/fftSize
	 *	https://fr.wikipedia.org/wiki/VU-m%C3%A8tre
	 */

	let vuMeter = document.currentScript.ownerDocument.querySelector("#wc-vumeter");

	class VUMetre extends HTMLElement
	{
		constructor(audioAnalyser)
		{
			super();

			this._root = this.attachShadow({ mode: 'open' });
			this._root.appendChild(vuMeter.content.cloneNode(true));

			if(audioAnalyser)
			{
				this.canvas = document.querySelector("canvas");
				this.graphicContext = this.canvas.getContext("2d");
				this.audioAnalyser = audioAnalyser;

				this.setUp();
				this.draw();
			}
		}

		setUp()
		{
			this.audioAnalyse.fftSize = 2048;
			this.datasArray = new Uint8Array(this.audioAnalyser.fftSize);
			this.audioAnalyser.getByteTimeDomainData(datasArray);
		}

		draw()
		{
			const canvas = this.canvas;
			this.drawing = requestAnimationFrame(draw);

			this.audioAnalyser.getByteTimeDomainData(datasArray);

			canvas.fillStyle = 'rgb(200, 200, 200)';
			canvas.fillRect(0, 0, canvas.width, canvas.height);
			canvas.lineWidth = 2;
			canvas.strokeStyle = 'rgb(0,0,0)';

			canvas.beginPath();

			let sliceWidth = canvas.width * 1.0 / this.audioAnalyser.fftSize;
			let coordinateX = 0;

			for(let i = 0; i < this.audioAnalyser.fftSize; i++)
			{
				let value = this.datasArray[i] / 128.0;
				let coordinateY = value * canvas.height / 2;

				if(i === 0)
					canvas.moveTo(coordinateX, coordinateY)
				else
					canvas.lineTo(coordinateX, coordinateY);

				coordinateX += sliceWidth;
			}

			canvas.lineTo(canvas.width, canvas.height / 2);
			canvas.stroke();
		}
	}

	try
	{
		console.log("Element defined");
		customElements.define('wasabi-vumeter', VUMetre);
	}
	catch (error)
	{
		console.log(error);
		console.log("Element already defined");
	}

	analyse(audioAnalyser)
	{
		let elem = new VUMetre(audioAnalyser);
		return elem;
	}

</script>
