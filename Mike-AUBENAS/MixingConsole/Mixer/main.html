<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js"></script>
<script> WebAudioControlsOptions = { useMidi: 1 }; </script>
<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webaudio-controls.js"></script>
<script src="../ChannelMixer/main.js"></script>

<template id="wc-mixer">

	<style>

		:host 
		{
			width:500px;
			height:500px;
		}

		#arrayOfChannels
		{
			display: flex;
		}

	</style>

    <div id="arrayOfChannels"></div>

</template>

<script>

    let leMixer = document.currentScript.ownerDocument.querySelector("#wc-mixer");

	class MixerGUI extends HTMLElement 
	{
		constructor(plug) 
		{ 
			super();
			this._plug = plug;
			this._root = this.attachShadow({ mode: 'open' });
			this._root.appendChild(leMixer.content.cloneNode(true));
			this.urlChannel = "https://wasabi.i3s.unice.fr/WebAudioPluginBank/Mike-AUBENAS/MixingConsole/ChannelMixer";
			this.arrayNodeToConnectChannel = this._plug.getArrayNodeToConnect();
			/* this.channels = this.setInitialChannelsGUI(); */

			(async () => {
				for (let i = 0; i < this.arrayNodeToConnectChannel.length; i++) {
				await this.setInitialChannelsGUI(i,this.arrayNodeToConnectChannel);
			}
			})();
		}

		get properties() 
		{
			this.boundingRect = 
			{
				dataWidth: 
				{
					type: Number,
					value: 120
				},
				dataHeight: 
				{
					type: Number,
					value: 180
				}
			};

			return this.boundingRect;
		}

		setInitialChannelsGUI(i,araie)
		{
			var plugin = new window.WasabiChannelMixer(ctx, this.urlChannel, {"channelNumber" : i+1});

			return new Promise((resolve, reject) => {

				plugin.load().then((node) => {

				plugin.loadGui().then((elem) => {
				document.body.appendChild(elem);
				resolve(true);
				});
				araie[i].connect(node);
				node.connect(ctx.destination)
				})
				})
			}

			/* let divLine = this._root.querySelector("#arrayOfChannels");
			let divColumn = document.createElement("div");
			let divColumn2 = document.createElement("div");
			/* divColumn.className = "column";
			divColumn2.className = "column"; 
			divLine.appendChild(divColumn);
			divLine.appendChild(divColumn2);
			
			var plugin = new window.WasabiChannelMixer(ctx, this.urlChannel, {"channelNumber" : 1});
			var plugin2 = new window.WasabiChannelMixer(ctx, this.urlChannel,{"channelNumber" : 2});

			let _promise = new Promise((resolve, reject) => {

			plugin.load().then((node) => {

			plugin.loadGui().then((elem) => {
			divLine.appendChild(elem);
			resolve(true);
			});
			this.arrayNodeToConnectChannel[0].connect(node);
			node.connect(ctx.destination)
			})
			})


			_promise.then(e => {

			plugin2.load().then(node => {
			plugin2.loadGui().then((elem) => {
				divLine.appendChild(elem);
			});
			this.arrayNodeToConnectChannel[1].connect(node);
			node.connect(ctx.destination)

			}) 


			}) */
			/* let divLine = this._root.querySelector("#arrayOfChannels");
			let divColumn = document.createElement("div");
			divColumn.className = "column";
			divLine.appendChild(divColumn);

			var plugin = new window.WasabiChannelMixer(ctx, this.urlChannel);

			plugin.load().then((node) => 
			{
				plugin.loadGui().then((elem) => 
				{
					divColumn.appendChild(elem);
				});
			}); */

			/* let i = 0; */
			/* for(let i = 0; i < this._plug.getNumberOfChannels(); i++)
			{ 
				let _promise = new Promise((resolve, reject) => 
				{
					const options = {"channelNumber" : i + 1};
					const nodeToDeploy = this.arrayNodeToConnectChannel[i];

					const plugin = new window.WasabiChannelMixer(ctx, this.urlChannel, options);

					let divLine = this._root.querySelector("#arrayOfChannels");
					let divColumn = document.createElement("div");
					divColumn.className = "column";
					divLine.appendChild(divColumn);

					plugin.load().then((node) => 
					{
						plugin.loadGui().then((elem) => 
						{
							divColumn.appendChild(elem);
						});
						resolve(true);
						nodeToDeploy.connect(node);
						node.connect(ctx.destination);
					});
				});

				// _promise.then( () => { i++ });
			} */
			/* while(i < this._plug.getNumberOfChannels() ); */
	}

	try 
	{
		console.log("Element defined");
		customElements.define('wasabi-mixer', MixerGUI);
	} 
	catch(error)
	{
		console.log(error);
		console.log("Element already defined");      
	}


	createWAP = (plug) => 
	{
		console.log("mixeur :",plug);
		let elem = new MixerGUI(plug);
		return elem; 
	}

</script>