<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js"></script>
<script> WebAudioControlsOptions = { useMidi: 1 }; </script>
<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webaudio-controls.js"></script>
<script src="../ChannelMixer/main.js"></script>

<template id="wc-mixer">

	<style>

		:host
		{
			width:500px;
			height:500px;
		}

		#arrayOfChannels
		{
			display: flex;
		}

		#dropdown-change-position
		{
			background-color: rgb(30, 30, 30);

			box-shadow: 4px 5px 6px rgba(0, 0, 0, 0.7),
						inset -2px -2px 5px 0px rgba(0, 0, 0, 0.2),
						inset 3px 1px 1px 4px rgba(255, 255, 255, 0.2),
						1px 0px 1px 0px rgba(0, 0, 0, 0.9),
						0 2px 1px 0 rgba(0, 0, 0, 0.9),
						1px 1px 1px 0px rgba(0, 0, 0, 0.9);

			margin-top: 20px;
			display: none;
			border-radius: 5px;

			position: absolute;
		}

		#dropdown-change-position p
		{
			margin: 16px;

			font-family: helvetica, monospace;
			color: white;
			text-transform: uppercase;
			font-size: 10px;
		}

		#dropdown-change-position p:hover
		{
			cursor: pointer;
			display: block;

			background-color: rgb(80, 79, 79);

			-webkit-transition: background-color 200ms linear;
			-moz-transition: background-color 200ms linear;
			-o-transition: background-color 200ms linear;
			-ms-transition: background-color 200ms linear;
			transition: background-color 200ms linear;
		}

		wasabi-channelmixer
		{
			position: relative;
		}

		.overlay
		{
			position: absolute;
			z-index: 20;
		}

		.pedalLabelZone
		{
			height: 22px;
			width: 78.14px;
		}

	</style>

	<div id="arrayOfChannels"></div>

	<div id="dropdown-change-position" title="Move this channel to another location"></div>

</template>

<script>

	let leMixer = document.currentScript.ownerDocument.querySelector("#wc-mixer");

	class MixerGUI extends HTMLElement
	{
		constructor(plug)
		{
			super();
			this._plug = plug;
			this._root = this.attachShadow({ mode: 'open' });
			this._root.appendChild(leMixer.content.cloneNode(true));
			this.urlChannel = "https://wasabi.i3s.unice.fr/WebAudioPluginBank/Mike-AUBENAS/MixingConsole/ChannelMixer";
			this.arrayNodeToConnectChannel = this._plug.getArrayNodeToConnect();
			this.listOfWasabiChannels = [];

			(async () =>
			{
				for (let position = 0; position < this.arrayNodeToConnectChannel.length; position++)
				{
					await this.createAndConnectChannel(position, this.arrayNodeToConnectChannel);
				}
			})();

			this.createDropdownMenuForChangePosition();
		}

		createAndConnectChannel(position, arrayAudioNodes)
		{
			var plugin = new window.WasabiChannelMixer(ctx, this.urlChannel, {"channelNumber" : position + 1});

			return new Promise((resolve, reject) =>
			{
				plugin.load().then((node) =>
				{
					plugin.loadGui().then((elem) =>
					{
						this._root.querySelector('#arrayOfChannels').appendChild(elem);
						resolve(true);
					});

					arrayAudioNodes[position].connect(node);
					node.connect(ctx.destination);

					this.createOverlayableZoneFor("pedalLabel", position);
				});

				this.listOfWasabiChannels.push(plugin);
			})
		}

		createDropdownMenuForChangePosition()
		{
			const numberOfChannels = this._plug.getNumberOfChannels();
			const menu = this._root.querySelector("#dropdown-change-position");

			for(let i = 0; i < numberOfChannels; i++)
			{
				const channelButton = document.createElement("p");
				const textNode = document.createTextNode(`Channel ${i + 1}`);

				channelButton.appendChild(textNode);
				menu.appendChild(channelButton);
			}

			menu.setAttribute("channelLinked", 'none');

			this.setMenuChangePositionChannelListener();
		}

		setMenuChangePositionChannelListener()
		{
			let buttons = this._root.querySelectorAll("#dropdown-change-position p");

			for(let i = 0; i < buttons.length; i++)
			{
				let button = buttons[i];

				button.addEventListener("click", () =>
				{
					let text = button.innerHTML;
					let channelLinked = this._root.querySelector("#dropdown-change-position").getAttribute("channelLinked");
					this.changeChannelPosition(channelLinked, text.substr(text.length -1));
				});
			}
		}

		changeChannelPosition(channelLinked, destination)
		{
			if( (channelLinked != 'none') && (channelLinked != destination) )
			{
				let arrayOfWebComponentsChannel = this._root.querySelectorAll("#arrayOfChannels wasabbi-channelmixer");

				let previousWebComponent = this._root.querySelector(`wasabi-channelmixer[channelNumber="${channelLinked}"]`);
				let destinationWebComponent = this._root.querySelector(`wasabi-channelmixer[channelNumber="${destination}"]`);

				let channelListDiv = this._root.querySelector("#arrayOfChannels");

				previousWebComponent.remove();

				channelListDiv.insertBefore(previousWebComponent, channelListDiv.childNodes[destination - 1]);

				/* let newDiv = swap(channelListDiv.children, channelLinked, destination);

				(function eraseDiv()
				{
					while(channelListDiv.firstChild)
						channelListDiv.removeChild(channelListDiv.firstChild);
				}());

				(function replaceWithNewElements()
				{
					newDiv.forEach( element =>
					{
						channelListDiv.appendChild(element);
					});
				}()); */



				/*(function rewriteAllChannelNumbers()
				{
					let wcChannels = channelListDiv.children;

					for(let i = 0; i < wcChannels.length; i++)
					{
						wcChannels[i].setAttribute("channelNumber", i + 1);
					}
				}());

				(function repositionOverlays()
				{
					// TODO
				}()); */

				////////////////////////////////////////////////////////////////////////////////////

				// See -> https://goo.gl/tvc6eD
				function swap(htmlCollection, element1, element2)
				{
					let array = Array.from( htmlCollection );
					var temp = array[element1];

					array[element1] = array[element2];
					array[element2] = temp;

					return array;
				}

			}
		}

		/**
		 *	Creates a div element that overlay a Channel WebComonent at the position passed at zone so that we
		 * 	can interact with it through the Mixer.
		 *
		 *	@param	{string}	zone	The zone we want to overlay
		 *	@param	{number}	channelNumber	The channel we want to add thr overlay to
		 */
		createOverlayableZoneFor(zone, channelNumber)
		{
			let overlayElement  = document.createElement("div");
			overlayElement.className = "overlay";

			switch(zone)
			{
				case "pedalLabel" :
					const overlayType = "pedalLabelZone";

					let isMenuOnFocus = false;

					overlayElement.className += ` ${overlayType}`// TODO in switch case
					overlayElement.id = `${overlayType}${channelNumber}`;

					overlayElement.style.left = `${(channelNumber * 100) + 20}px`
					overlayElement.style.top = `${260}px`;

					let menu = this._root.querySelector("#dropdown-change-position");

					overlayElement.addEventListener("mouseover", () =>
					{
						menu.style.display = "inline-block";
						menu.style.left = `${(channelNumber * 100) + 10}px`;
						menu.setAttribute("channelLinked", channelNumber + 1);

						isMenuOnFocus = true;
					});

					overlayElement.addEventListener("mouseleave", () =>
					{
						isMenuOnFocus = false;
						makeMenuDisappear();
					});

					menu.addEventListener("mouseleave", () =>
					{
						isMenuOnFocus = false;
						makeMenuDisappear();
					});

					menu.addEventListener("mouseover", () =>
					{
						isMenuOnFocus = true;
					});

					////////////////////////////////////////////////////////////////////////

					function makeMenuDisappear()
					{
						setTimeout(() =>
						{
							if(isMenuOnFocus == false)
								menu.style.display = "none";
						}, 100);
					}
					break;
				case "solo" :
					// TODO
					break;
			}

			this._root.querySelector('#arrayOfChannels').appendChild(overlayElement);
		}
	}

	try
	{
		console.log("Element defined");
		customElements.define('wasabi-mixer', MixerGUI);
	}
	catch(error)
	{
		console.log(error);
		console.log("Element already defined");
	}


	createWAP = (plug) =>
	{
		console.log("mixeur :",plug);
		let elem = new MixerGUI(plug);
		return elem;
	}

</script>