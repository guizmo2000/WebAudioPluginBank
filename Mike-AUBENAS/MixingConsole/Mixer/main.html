<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js"></script>
<script> WebAudioControlsOptions = { useMidi: 1 }; </script>
<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webaudio-controls.js"></script>
<script src="../ChannelMixer/main.js"></script>

<template id="wc-mixer">

	<style>

		:host
		{
			width:500px;
			height:500px;
		}

		#arrayOfChannels
		{
			display: flex;
		}

		#addButton
		{
			padding-top: 10px;
			width: 25px;
			height: 25px;
		}

	</style>

	<div id="arrayOfChannels"></div>

	<canvas id="addButton"></canvas>

</template>

<script>

    let leMixer = document.currentScript.ownerDocument.querySelector("#wc-mixer");

	class MixerGUI extends HTMLElement
	{
		constructor(plug)
		{
			super();
			this._plug = plug;
			this._root = this.attachShadow({ mode: 'open' });
			this._root.appendChild(leMixer.content.cloneNode(true));
			this.urlChannel = "https://wasabi.i3s.unice.fr/WebAudioPluginBank/Mike-AUBENAS/MixingConsole/ChannelMixer";
			this.arrayNodeToConnectChannel = this._plug.getArrayNodeToConnect();

			(async () =>
			{
				for (let position = 0; position < this.arrayNodeToConnectChannel.length; position++)
				{
					await this.createAndConnectChannel(position, this.arrayNodeToConnectChannel);
				}
			})();

			this.createAddButton("black");
		}

		createAndConnectChannel(position, arrayAudioNodes)
		{
			var plugin = new window.WasabiChannelMixer(ctx, this.urlChannel, {"channelNumber" : position + 1});

			return new Promise((resolve, reject) =>
			{
				plugin.load().then((node) =>
				{
					plugin.loadGui().then((elem) => {
					this._root.querySelector('#arrayOfChannels').appendChild(elem);
					resolve(true);
					});

					arrayAudioNodes[position].connect(node);
					node.connect(ctx.destination)
				})
			})
		}

		createAddButton(color)
		{
			const canvas = this._root.querySelector("#addButton");
			const graphicContext = canvas.getContext("2d");

			graphicContext.strokeStyle = color;
			graphicContext.lineWidth = 20;

			graphicContext.beginPath();

			graphicContext.moveTo( (canvas.width / 2), 0);
			graphicContext.lineTo( (canvas.width / 2), canvas.height );

			graphicContext.moveTo( 0, (canvas.height / 2))
			graphicContext.lineTo( canvas.width, (canvas.height / 2) );

			graphicContext.stroke();

			//////////////////////////////////////////////////////////////////////////////////////////

			(function setAddButtonListener()
			{
				canvas.addEventListener("click", () =>
				{
					this.createAndConnectChannel(// TODO);
				});
			}());
		}

	}

	try
	{
		console.log("Element defined");
		customElements.define('wasabi-mixer', MixerGUI);
	}
	catch(error)
	{
		console.log(error);
		console.log("Element already defined");
	}


	createWAP = (plug) =>
	{
		console.log("mixeur :",plug);
		let elem = new MixerGUI(plug);
		return elem;
	}

</script>