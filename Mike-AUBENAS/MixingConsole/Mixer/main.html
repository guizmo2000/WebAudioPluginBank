<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js"></script>
<script> WebAudioControlsOptions = { useMidi: 1 }; </script>
<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webaudio-controls.js"></script>
<script src="../ChannelMixer/main.js"></script>

<template id="wc-mixer">

	<style>

		:host
		{
			width:500px;
			height:500px;
		}

		#arrayOfChannels
		{
			display: flex;
		}

		#dropdown-change-position
		{
			background-color: rgb(30, 30, 30);

			box-shadow: 4px 5px 6px rgba(0, 0, 0, 0.7),
						inset -2px -2px 5px 0px rgba(0, 0, 0, 0.2),
						inset 3px 1px 1px 4px rgba(255, 255, 255, 0.2),
						1px 0px 1px 0px rgba(0, 0, 0, 0.9),
						0 2px 1px 0 rgba(0, 0, 0, 0.9),
						1px 1px 1px 0px rgba(0, 0, 0, 0.9);

			margin-top: 20px;
			display: none;
			border-radius: 5px;

			position: absolute;
		}

		#dropdown-change-position p
		{
			margin: 16px;

			font-family: helvetica, monospace;
			color: white;
			text-transform: uppercase;
			font-size: 10px;
		}

		#dropdown-change-position p:hover
		{
			cursor: pointer;
			display: block;

			background-color: rgb(80, 79, 79);

			-webkit-transition: background-color 200ms linear;
			-moz-transition: background-color 200ms linear;
			-o-transition: background-color 200ms linear;
			-ms-transition: background-color 200ms linear;
			transition: background-color 200ms linear;
		}

		wasabi-channelmixer
		{
			position: relative;
		}

		.overlay
		{
			background-color: black;
			position: absolute;
			z-index: 20;
		}

		.pedalLabelZone
		{
			height: 22px;
			width: 78.14px;
		}

	</style>

	<div id="arrayOfChannels"></div>

	<div id="dropdown-change-position"></div>

</template>

<script>

	let leMixer = document.currentScript.ownerDocument.querySelector("#wc-mixer");

	class MixerGUI extends HTMLElement
	{
		constructor(plug)
		{
			super();
			this._plug = plug;
			this._root = this.attachShadow({ mode: 'open' });
			this._root.appendChild(leMixer.content.cloneNode(true));
			this.urlChannel = "https://wasabi.i3s.unice.fr/WebAudioPluginBank/Mike-AUBENAS/MixingConsole/ChannelMixer";
			this.arrayNodeToConnectChannel = this._plug.getArrayNodeToConnect();

			(async () =>
			{
				for (let position = 0; position < this.arrayNodeToConnectChannel.length; position++)
				{
					await this.createAndConnectChannel(position, this.arrayNodeToConnectChannel);
				}
			})();

			this.createDropdownMenuForChangePosition();
		}

		createAndConnectChannel(position, arrayAudioNodes)
		{
			var plugin = new window.WasabiChannelMixer(ctx, this.urlChannel, {"channelNumber" : position + 1});

			return new Promise((resolve, reject) =>
			{
				plugin.load().then((node) =>
				{
					plugin.loadGui().then((elem) => {
					this._root.querySelector('#arrayOfChannels').appendChild(elem);
					resolve(true);
					});

					arrayAudioNodes[position].connect(node);
					node.connect(ctx.destination);

					this.createOverlayableZoneFor("pedalLabel", position);
				})
			})
		}

		createDropdownMenuForChangePosition()
		{
			const numberOfChannels = this._plug.getNumberOfChannels();
			const divDropDown = this._root.querySelector("#dropdown-change-position");

			for(let i = 0; i < numberOfChannels; i++)
			{
				const channelButton = document.createElement("p");
				const textNode = document.createTextNode(`Channel ${i + 1}`);

				channelButton.appendChild(textNode);
				divDropDown.appendChild(channelButton);
			}
		}

		/**
		 *	Creates a div element that overlay a Channel WebComonent at the position passed at zone so that we
		 * 	can interact with it through the Mixer.
		 *
		 *	@param	{string}	zone	The zone we want to overlay
		 *	@param	{number}	channelNumber	The channel we want to add thr overlay to
		 */
		createOverlayableZoneFor(zone, channelNumber)
		{
			let overlayElement  = document.createElement("div");
			overlayElement.className = "overlay";

			switch(zone)
			{
				case "pedalLabel" :
					const overlayType = "pedalLabelZone";

					let isMenuOnFocus = false;

					overlayElement.className += ` ${overlayType}`// TODO in switch case
					overlayElement.id = `${overlayType}${channelNumber}`;

					overlayElement.style.left = `${(channelNumber * 100) + 20}px`
					overlayElement.style.top = `${320}px`;

					let menu = this._root.querySelector("#dropdown-change-position");

					overlayElement.addEventListener("mouseover", () =>
					{
						menu.style.display = "inline-block";
						menu.style.left = `${(channelNumber * 100) + 10}px`;
					});

					overlayElement.addEventListener("mouseleave", () =>
					{
						isMenuOnFocus = false;
						makeMenuDisappear();
					});

					menu.addEventListener("mouseleave", () =>
					{
						isMenuOnFocus = false;
						makeMenuDisappear();
					});

					menu.addEventListener("mouseover", () =>
					{
						isMenuOnFocus = true;
					});

					////////////////////////////////////////////////////////////////////////

					function makeMenuDisappear()
					{
						setTimeout(() =>
						{
							if(isMenuOnFocus == false)
								menu.style.display = "none";
						}, 100);
					}
					break;
			}

			this._root.querySelector('#arrayOfChannels').appendChild(overlayElement);
		}
	}

	try
	{
		console.log("Element defined");
		customElements.define('wasabi-mixer', MixerGUI);
	}
	catch(error)
	{
		console.log(error);
		console.log("Element already defined");
	}


	createWAP = (plug) =>
	{
		console.log("mixeur :",plug);
		let elem = new MixerGUI(plug);
		return elem;
	}

</script>