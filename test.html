<!-- Plugin dependencies 
     The Delay depends on Polymer 2 because it uses the webaudiocontrols knobs, etc
     that also depend on Polymer. If we remove this dependency, then the delay
     would have zero dependencies on its own.

     These should be located on a "shared" repo, or on CDNs
-->
<script src="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<link rel="import" href="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/bower_components/polymer/polymer.html">
<link rel="import" href="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/bower_components/webaudio-controls/webaudio-controls.html">
<link rel="stylesheet" href="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/bower_components/mocha/mocha.css">
<!-- Plugin in its redistribuable form, note that we use here an 
     absolute URL, that means that YOU can use it too in YOUR html page/host -->
<!-- <link rel="import" href="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/wc-delay.html"> -->

<!-- Here we have a VERY preliminary code that unit tests the API,
     with hard coded names etc. -->
<!-- <script src="./testAPI.js"></script> -->

<!-- What follows is an example of html/js code that instanciates it :
The wc-pingpongdelay html tag is the custom element defined in the 
imported html file of the redistribuable plugin
The instruction:
let wcdelay = document.getElementById("WCdelay");

here wcdelay is the plugin object that implements the plugin API
-->
<!doctype html>
<html>
<style include="shared-styles">
  #plugin {
    top: 30%;
    left: 20%;
  }

  #mocha {
    position: relative;
    top: 20%;

  }
</style>

<title>Plugin tester</title>
</head>

<body>
  <div class="title">
    <h1>Plugin Tester</h1>
  </div>
  <div class="content" id="main">
    <audio src="./BasketCaseGreendayriffDI.mp3" id="soundSample" controls loop></audio>
    <h3>Paste here the link to your webaudio plugin</h3>
    URL:
   <input type="text" id="urlPlugin" name="url" value="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/wc-delay.html"> <!--Name of the WC : -->
    <button onclick="loadPlugin()">Load it</button>
    <button onclick="buildPlugin(); testPlugin();">Test it</button>
  </div>
  <div id="mocha"></div>
  <script src="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/bower_components/mocha/mocha.js"></script>
  <script src="https://wasabi.i3s.unice.fr/plugins/delay-plugin/WebAudioPluginBank/node_modules/chai/chai.js"></script>
  <script>mocha.setup('bdd')</script>
</body>
<script>
  var AudioContext = window.AudioContext || window.webkitAudioContext;
  var contexteAudio = new AudioContext();
  let player = document.getElementById("soundSample");
  let mediaSource = contexteAudio.createMediaElementSource(player);

  function loadPlugin() {
    let link = document.createElement('link');
    link.rel = "import";
    link.href = document.getElementById("urlPlugin").value;
    link.id="linkPlugin";
    document.body.appendChild(link);
    
  }
  function buildPlugin() {

    if (supportsImports()) {
      // Good to go!
      // here we get the name of the dom-module name defined in the wc by exploring the import
      let plugin = document.createElement(document.getElementById("linkPlugin").import.body.querySelector("dom-module").id);
      plugin.setAttribute("id", "plugin");
      document.getElementById("main").appendChild(plugin);
      plugin.buildGraph(contexteAudio);
      mediaSource.connect(plugin.getEffect().getInputNode());


      // the proposed plugin does is not yet compliant with the API from the paper
      // it acts like the "host" of the plugin in the wam/fasut sense
      // we could have wcdelay.node or wcdelay.getRootNode() ... ?
      plugin.getEffect().getOutputNode().connect(contexteAudio.destination);
    } else {
      console.log("imports are not loaded")
    }



  }
  // to test if the load has succeeded
  function supportsImports() {
    return 'import' in document.createElement('link');
  }
  /* 
  here we use mocha chai.js to apply unit test on the plugin. The test cases cover the existence and (soon) the type of the API calls.
  */ 
  function testPlugin() {
    var expect = chai.expect;
    var assert = chai.assert;
    var plugin = document.getElementById("plugin");


    describe('Metadata', function () {
      it('plugin should have a JSON getMetadata() method', function () {
        expect(plugin.getEffect().getMetadata()).to.exist;
      });
      it('the getMetadata() function should return a json object', function () {
        expect(plugin.getEffect().getMetadata()).to.not.be.empty;
      });
    });


    describe('Descriptor', function () {
      it('plugin should have a JSON getDescriptor() method', function () {
        expect(plugin.getEffect().getDescriptor()).to.exist;
      });
      it('getDescriptor() function should return a json object', function () {
        expect(plugin.getEffect().getDescriptor()).to.not.be.empty;
      });
    });


    describe('Param getter', function () {
      it('plugin should have a getParam(key) method', function () {
        expect(plugin.getEffect().getParam(key)).to.exist;
      });
      it('the getParam() function should  not be empty', function () {
        expect(plugin.getEffect().getParam(key)).to.not.be.empty;
      });
    });


    describe('Param setter', function () {
      it('plugin should have a setParam(key,value) method', function () {
        expect(plugin.getEffect().setParam(key,value)).to.exist;
      });
    });


    describe('Patch getter', function () {
      it('plugin should have a getPatch(key) method', function () {
        expect(plugin.getEffect().getPatch(data)).to.exist;
      });
      it('the getMetadata() function should  not be empty', function () {
        expect(plugin.getEffect().getPatch(data)).to.not.be.empty;
      });
    });


    describe('Patch setter', function () {
      it('plugin should have a setPatch(key,value) method', function () {
        expect(plugin.getEffect().setPatch(data,index)).to.exist;
      });
    });


    describe('State getter', function () {
      it('plugin should have a getState(key) method', function () {
        expect(plugin.getEffect().getState(state)).to.exist;
      });
      it('the getMetadata() function should  not be empty', function () {
        expect(plugin.getEffect().getState(state)).to.not.be.empty;
      });
    });


    describe('State setter', function () {
      it('plugin should have a setState(key,value) method', function () {
        expect(plugin.getEffect().setState(state)).to.exist;
      });
    });

    describe('midi enable', function () {
      it('plugin should have a onMidi(msg) method', function () {
        expect(plugin.getEffect().onMidi(msg)).to.exist;
      });
    });

    describe('Patches array', function () {
      it('plugin should have a patchNames field', function () {
        expect(plugin.getEffect().patchNames).to.exist;
      });
      it('patchNames should be instanceOf String []', function () {
        expect(plugin.getEffect().patchNames).to.be.an.instanceof(array);
      });
    });

    describe('Input Channel Number', function () {
      it('plugin should have an inputChannelCount() method', function () {
        expect(plugin.getEffect().inputChannelCount()).to.exist;
      });
    });

    


    mocha.run();
  }

</script>




</html>